<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ArcGIS – AVG Water Level (ft/in)</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, sans-serif; margin: 0; padding: 0; background: #f7f7f8; color: #111; }
    header { background: #0b5fff; color: white; padding: 1rem 1.25rem; }
    main { padding: 1rem 1.25rem 2rem; max-width: 800px; margin: 0 auto; }
    h1 { font-size: 1.25rem; margin: 0; }
    .status { margin-top: .5rem; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; }
    table { width: 100%; border-collapse: collapse; background: white; margin-top: 1rem; }
    th, td { border: 1px solid #ddd; padding: .6rem .7rem; text-align: left; }
    th { background: #f0f4ff; }
    .error { color: #b00020; }
    footer { margin-top: 2rem; color: #666; font-size: .9rem; }
    code { background: #eef2ff; padding: 0 .25rem; border-radius: .25rem; }
    .actions { margin-top: .75rem; }
    button { padding: .45rem .7rem; font-size: .95rem; cursor: pointer; border: 1px solid #0b5fff; background: #0b5fff; color: white; border-radius: .4rem; }
    .small { font-size: .9rem; color: #eef2ff; }
  </style>
</head>
<body>
  <header>
    <h1>Average Water Level (Last 2 Hours)</h1>
    <div class="small">Shows only the converted value in <strong>feet & inches</strong> (inches rounded to nearest whole inch).</div>
    <div class="actions">
      <button id="refreshBtn">Refresh now</button>
    </div>
    <div class="status" id="status">Idle.</div>
  </header>

  <main>
    <section>
      <table id="avgTable" aria-label="AVG Water Level">
        <thead>
          <tr>
            <th>AVG Water Level (ft/in)</th>
          </tr>
        </thead>
        <tbody id="avgBody">
          <tr><td>Loading…</td></tr>
        </tbody>
      </table>
      <footer>
        <p><strong>Note:</strong> If the browser blocks network requests from a local file (CORS), run <code>python -m http.server</code> and open the page via <code>http://localhost:8000</code>.</p>
      </footer>
    </section>
  </main>

  <script>
    const statusEl = document.getElementById('status');
    const refreshBtn = document.getElementById('refreshBtn');
    const avgBody = document.getElementById('avgBody');

    // Fixed endpoint (no inputs as requested)
    const ENDPOINT = "https://services3.arcgis.com/J7ZFXmR8rSmQ3FGf/arcgis/rest/services/gauges_2_view/FeatureServer/0/query?f=json&where=CreationDate%20BETWEEN%20(CURRENT_TIMESTAMP%20-%20INTERVAL%20'2'%20HOUR)%20AND%20CURRENT_TIMESTAMP%20AND%20gauge%3D%27Nagalagam%20Street%27&outFields=*&returnGeometry=false&resultType=standard&outStatistics=%5B%7B%22onStatisticField%22%3A%22water_level%22%2C%22outStatisticFieldName%22%3A%22AVG_WATER_LEVEL%22%2C%22statisticType%22%3A%22avg%22%7D%5D";

    const REFRESH_MS = 15 * 60 * 1000; // 15 minutes
    let timerId = null;

    function fmtDate(d) { return new Date(d).toLocaleString(); }
    function setStatus(msg, isError=false) { statusEl.textContent = msg; statusEl.className = isError ? 'status error' : 'status'; }

    // Convert decimal feet to feet & inches (0 decimal places for inches)
    function toFeetInchesZero(value) {
      if (value === null || value === undefined || isNaN(value)) return '';
      // Assumption: value is in decimal feet
      const feetTotal = value;
      const feet = Math.trunc(feetTotal);
      let inches = Math.round((feetTotal - feet) * 12); // 0 precision
      if (inches >= 12) { inches -= 12; return `${feet + 1} ft ${inches} in`; }
      return `${feet} ft ${inches} in`;
    }

    function renderAvg(values) {
      avgBody.innerHTML = '';
      if (!values || values.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.textContent = 'No data';
        tr.appendChild(td);
        avgBody.appendChild(tr);
        return;
      }
      values.forEach(v => {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.textContent = toFeetInchesZero(v);
        tr.appendChild(td);
        avgBody.appendChild(tr);
      });
    }

    async function fetchAndRender() {
      setStatus('Fetching…');
      try {
        const res = await fetch(ENDPOINT, { method: 'GET' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        // ArcGIS outStatistics typically returns one feature with attributes.AVG_WATER_LEVEL
        const features = data.features || [];
        const values = features.map(f => f?.attributes?.AVG_WATER_LEVEL).filter(v => v !== undefined && v !== null);
        renderAvg(values);
        const now = new Date();
        setStatus(`Last updated: ${fmtDate(now)} | ${values.length} value(s)`);
      } catch (err) {
        console.error(err);
        setStatus(`Error: ${err.message}`, true);
        avgBody.innerHTML = '<tr><td class="error">Failed to load data.</td></tr>';
      }
    }

    function startAutoRefresh() {
      if (timerId) clearInterval(timerId);
      timerId = setInterval(fetchAndRender, REFRESH_MS);
    }

    refreshBtn.addEventListener('click', fetchAndRender);

    // Initial load + timer
    fetchAndRender();
    startAutoRefresh();
  </script>
</body>
</html>
